<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, minimum-scale=1">
  <title>小码短链接</title>

  <!-- 公共：获取url的参数 -->
  <script>
    // eslint-disable-next-line no-unused-vars
    function getUrlQuery() {
      var search = window.location.search.slice(1).split('&')
      var query_map = {}
      var param_arr

      search.forEach(function(param) {
        if (param && param.indexOf('=') !== -1) {
          param_arr = param.split('=')
          query_map[param_arr[0]] = query_map[param_arr[0].toLocaleLowerCase()] = decodeURIComponent(param_arr[1] || '')
        }
      })

      console.log({
        query_map
      })
      return query_map
    }
  </script>

  <!-- 跳转用户授权 url -->
  <script>
    /* eslint-disable no-unused-vars */
    var wx_info = {
      appid: 'wxc8f356adb367c7b6',
      // redirect_uri: 'http://192.168.3.27:8081/public/wx-visit.html',
      redirect_uri: 'http://admin-test.xiaomark.com/wx-visit.html',
      response_type: 'code',
      // scope: 'snsapi_base', // 静默授权
      scope: 'snsapi_userinfo',
      state: 'lijing'
    }
    var wx_url = 'https://open.weixin.qq.com/connect/oauth2/authorize?'

    Object.keys(wx_info).forEach(function(key, i) {
      if (i !== 0) {
        wx_url += '&'
      }
      wx_url = wx_url + key + '=' + encodeURIComponent(wx_info[key])
    })

    wx_url = wx_url + '#wechat_redirect'

    console.log('wx_url:', wx_url)
  </script>

  <!-- 立即执行防抖函数 -->
  <script>
    // eslint-disable-next-line no-unused-vars
    function debounce({ delay, successCb }) {
      var timer_target = null

      return function() {
        // eslint-disable-next-line no-underscore-dangle
        var _delay = delay || 1000

        if (!timer_target) {
          typeof successCb === 'function' && successCb()
        }
        if (timer_target) {
          clearTimeout(timer_target)
        }
        timer_target = setTimeout(function() {
          // eslint-disable-next-line no-undefined
          timer_target = undefined
        }, _delay)
      }
    }
  </script>

  <!-- 业务：是否是微信浏览器的处理 -->
  <script>
    var target_url = 'https://www.baidu.com'
    var is_weixin_browser = /micromessenger/.test(window.navigator.userAgent.toLowerCase())

    window.addEventListener('load', function() {
      // eslint-disable-next-line no-undef
      var wx_code = (getUrlQuery() || {}).code // 微信授权成功后会有这个参数

      // 获取页面重的元素
      var div__test1 = document.getElementById('div__test1')
      var div__test = document.getElementById('div__test')
      var btn__target = document.getElementById('btn__target')
      var btn__wx = document.getElementById('btn__wx')

      var count = 0
      var auto_sum = 10

      // x秒后，自动打开目标页
      var handleAutoToTarget = function() {
        count++
        div__test1.textContent = auto_sum - count + ' s 后自动跳转'
        if (count === auto_sum) {
          // eslint-disable-next-line no-use-before-define
          handleToTarget()
          // eslint-disable-next-line no-use-before-define
          clearInterval(timer_auto)
        }
      }
      var timer_auto = setInterval(handleAutoToTarget, 1000)

      // 打开目标页
      var handleToTarget = function() {
        div__test.innerHTML = '直接跳转:' + target_url
        window.location.replace(target_url)
        clearInterval(timer_auto)
      }

      if (is_weixin_browser && !wx_code) {
        // 感觉可以先用静默授权，用oppenid去获取用户信息，有的话直接跳转目标，没有的话就跳转授权
        // 显示在浏览器中打开
        // eslint-disable-next-line no-undef
        window.location.replace(wx_url) // 没有授权，跳转授权（拒绝授权后，不会重定向会本目标页）
        // eslint-disable-next-line no-undef
        // window.location.href = wx_url // 没有授权，跳转授权（拒绝授权后，不会重定向会本目标页）

        div__test.innerHTML = '当前网页的地址：' + window.location.href

        // 点击跳转防抖
        // eslint-disable-next-line no-undef,vars-on-top
        var handleBtnTarget = debounce({
          successCb: handleToTarget
        })
        // 点击重新授权防抖
        // eslint-disable-next-line no-undef,vars-on-top
        var handleBtnWx = debounce({
          successCb: function() {
            // eslint-disable-next-line no-undef
            window.location.href = wx_url
          }
        })

        // 按钮点击事件绑定
        btn__target.addEventListener('click', handleBtnTarget)
        btn__wx.addEventListener('click', handleBtnWx)

        // 显示按钮
        btn__target.style.display = 'flex'
        btn__wx.style.display = 'flex'
      } else {
        // 直接跳转
        handleToTarget()
      }
    })
  </script>

  <!-- 公共：计算页面 html 的 font-size -->
  <script>
    /* 备注：设置html的font-size，用于rem的计算，按照375的设计稿 */
    var w_document = document.documentElement.clientWidth

    document.documentElement.style.fontSize = w_document / 375 + 'px'
  </script>

  <!-- 公共：XMLHttpRequest 的 GET 和 POST 的封装 -->
  <script type="text/javascript">
    /* eslint-disable vars-on-top */
    // eslint-disable-next-line no-unused-vars
    function request(option) {
      if (String(option) !== '[object Object]') {
        return false
      }

      option.method = option.method ? option.method.toUpperCase() : 'GET'
      option.data = option.data || {}

      // GET 的参数
      var formData = []

      for (var key in option.data) {
        formData.push(''.concat(key, '=', encodeURIComponent(option.data[key])))
      }
      option.data = formData.join('&')

      if (option.method === 'GET') {
        option.url += location.search.length === 0 ? ''.concat(option.data ? '?' : '', option.data) : ''.concat('&', option.data)
      }

      // 新建一个请求
      var xhr = new XMLHttpRequest()

      xhr.responseType = option.responseType || 'json'

      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            if (option.success && typeof option.success === 'function') {
              typeof option.success === 'function' && option.success(xhr.response)
            }
          } else if (option.error && typeof option.error === 'function') {
            typeof option.error === 'function' && option.error()
          }
        }
      }

      xhr.open(option.method, option.url, true)

      if (option.method === 'POST') {
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
      }

      xhr.send(option.method === 'POST' ? option.data : null)
    }
  </script>

  <!-- 业务：接口请求 -->
  <script>
    // 测试接口的请求
    // eslint-disable-next-line no-undef
    // request({
    //   url: 'https://xiaomark.com/api/slmp/links/aseh7loi/',
    //   method: 'GET',
    //   data: {},
    //   success: function(res) {
    //     console.log({
    //       res
    //     })
    //   },
    //   error: function(err) {
    //     console.log({
    //       err
    //     })
    //   }
    // })
  </script>

  <!-- 页面样式 -->
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
    }

    /* html {
      font-size: 4%;
    } */
    #container {
      width: 100vw;
      height: 100vh;
      font-size: 14rem;
      line-height: 20rem;
      position: relative;
      background: pink;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .btn {
      width: 120rem;
      height: 40rem;
      font-size: 14rem;
      border-radius: 4rem;
      border: 1px solid #a8a8a8;
      align-items: center;
      justify-content: center;
      display: none;
    }

    #btn__target {
      margin-top: 12rem;
      margin-bottom: 12rem;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="div__test1">倒计时</div>
    <div id="div__test"></div>
    <div id="btn__target" class="btn">跳转到目标页</div>
    <div id="btn__wx" class="btn">重新授权</div>
  </div>
</body>

</html>